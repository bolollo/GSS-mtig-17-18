<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Ejemplo Sentilo ACA &mdash; geotalleres-teoria 1 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/geotalleres.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.1.0/readable/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="geotalleres-teoria 1 documentation" href="../index.html" />
    <link rel="next" title="Geoservicios realtime" href="../geoservicios-realtime/geoservicios-realtime.html" />
    <link rel="prev" title="Ejemplo sensores port Barcelona" href="../ejemplo-sensores-port-bcn/ejemplo-sensores-port-bcn.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          GeoTalleres</a>
        <span class="navbar-text navbar-version pull-left"><b>1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Nav <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduccion-smart-cities/introduccion-smart-cities.html">Introducción a las Smart Cities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduccion-smart-cities/introduccion-smart-cities.html#apartado">Apartado</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conceptos-geoservicios/conceptos_geoservicios.html">Conceptos básicos de Geoservicios</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conceptos-geoservicios/conceptos_geoservicios.html#geoservicio">Geoservicio</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conceptos-sensores/conceptos-sensores.html">Conceptos sensores</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conceptos-sensores/conceptos-sensores.html#apartado">Apartado</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../conceptos-opendata/conceptos-opendata.html">Conceptos Open data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conceptos-opendata/conceptos-opendata.html#apartado">Apartado</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../utilizacion-servicio-opendata/utilizacion-servicio-opendata.html">Utilización de servicios Open data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../utilizacion-servicio-opendata/utilizacion-servicio-opendata.html#ejemplo-api-ckan">Ejemplo API CKAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilizacion-servicio-opendata/utilizacion-servicio-opendata.html#ejemplos-api-socrata">Ejemplos API SOCRATA</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../servicios-realtime-opendata/servicios-realtime-opendata.html">Servicios realtime Open data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../servicios-realtime-opendata/servicios-realtime-opendata.html#problemas-frecuentes-al-trabajar-con-servicios-open-data">Problemas frecuentes al trabajar con servicios Open Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../servicios-realtime-opendata/servicios-realtime-opendata.html#ejemplo-de-buenas-practicas">Ejemplo de buenas prácticas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../servicios-realtime-opendata/servicios-realtime-opendata.html#ejemplo-de-malas-practicas">Ejemplo de malas prácticas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../herramientas-visualizacion-opendata/herramientas-visualizacion-opendata.html">Herramientas de visualización Opendata</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../herramientas-visualizacion-opendata/herramientas-visualizacion-opendata.html#librerias">Librerias</a></li>
<li class="toctree-l2"><a class="reference internal" href="../herramientas-visualizacion-opendata/herramientas-visualizacion-opendata.html#servicios">Servicios</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ejemplo-servicio-bicing-bcn/ejemplo-servicio-bicing-bcn.html">Ejemplo servicio bicing Barcelona</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-servicio-bicing-bcn/ejemplo-servicio-bicing-bcn.html#acceso-al-servicio-de-datos-del-bicing-de-barcelona">Acceso al servicio de datos del Bicing de Barcelona</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-servicio-bicing-bcn/ejemplo-servicio-bicing-bcn.html#creacion-de-un-visor">Creación de un visor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-servicio-bicing-bcn/ejemplo-servicio-bicing-bcn.html#creacion-del-proxy">Creación del proxy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../servicios-realtime-sensores/servicios-realtime-sensores.html">Servicios realtime sensores</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../servicios-realtime-sensores/servicios-realtime-sensores.html#problemas-frecuentes-al-trabajar-con-sensores">Problemas frecuentes al trabajar con sensores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../servicios-realtime-sensores/servicios-realtime-sensores.html#ejemplo-de-buenas-practicas">Ejemplo de buenas prácticas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../servicios-realtime-sensores/servicios-realtime-sensores.html#ejemplo-de-malas-practicas">Ejemplo de malas prácticas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ejemplo-sensores-port-bcn/ejemplo-sensores-port-bcn.html">Ejemplo sensores port Barcelona</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-sensores-port-bcn/ejemplo-sensores-port-bcn.html#acceso-al-servicio-de-datos-de-sensores-del-port-de-barcelona">Acceso al servicio de datos de sensores del Port de Barcelona</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-sensores-port-bcn/ejemplo-sensores-port-bcn.html#creacion-de-un-visor">Creación de un visor</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Ejemplo Sentilo ACA</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#acceso-al-servicios-de-sensores-sentilo-de-la-aca">Acceso al servicios de sensores Sentilo de la ACA</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creacion-de-un-visor">Creación de un visor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creacion-del-proxy">Creación del proxy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../geoservicios-realtime/geoservicios-realtime.html">Geoservicios realtime</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../geoservicios-realtime/geoservicios-realtime.html#id1">Geoservicios realtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geoservicios-realtime/geoservicios-realtime.html#geocodificacion">Geocodificación</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geoservicios-realtime/geoservicios-realtime.html#routing">Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geoservicios-realtime/geoservicios-realtime.html#isocronas">Isócronas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geoservicios-realtime/geoservicios-realtime.html#servicios-varios">Servicios varios</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../herramientas-visualizacion-geoservicios/herramientas-visualizacion-geoservicios.html">Herramientas de visualización geoservicios</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../herramientas-visualizacion-geoservicios/herramientas-visualizacion-geoservicios.html#librerias">Librerias</a></li>
<li class="toctree-l2"><a class="reference internal" href="../herramientas-visualizacion-geoservicios/herramientas-visualizacion-geoservicios.html#servicios">Servicios</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ejemplo-mapzen-mobility/ejemplo-mapzen-mobility.html">Ejemplo Mapzen Mobility</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-mapzen-mobility/ejemplo-mapzen-mobility.html#nota">NOTA</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ejemplo-geoservicio-realtime/ejemplo-geoservicio-realtime.html">Ejemplo Geoservicio realtime</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-geoservicio-realtime/ejemplo-geoservicio-realtime.html#servicio-realtime-para-compartir-la-ubicacion">Servicio realtime para compartir la ubicación</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-geoservicio-realtime/ejemplo-geoservicio-realtime.html#creacion-del-mapa">Creación del mapa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ejemplo-geoservicio-realtime/ejemplo-geoservicio-realtime.html#creacion-del-servicio-que-comparte-la-ubicacion-de-los-usuarios">Creación del servicio que comparte la ubicación de los usuarios</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Ejemplo Sentilo ACA</a><ul>
<li><a class="reference internal" href="#acceso-al-servicios-de-sensores-sentilo-de-la-aca">Acceso al servicios de sensores Sentilo de la ACA</a></li>
<li><a class="reference internal" href="#creacion-de-un-visor">Creación de un visor</a></li>
<li><a class="reference internal" href="#creacion-del-proxy">Creación del proxy</a><ul>
<li><a class="reference internal" href="#referencias">Referencias</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../ejemplo-sensores-port-bcn/ejemplo-sensores-port-bcn.html" title="Previous Chapter: Ejemplo sensores port Barcelona"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Ejemplo senso...</span>
    </a>
  </li>
  <li>
    <a href="../geoservicios-realtime/geoservicios-realtime.html" title="Next Chapter: Geoservicios realtime"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">Geoservicios ... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/ejemplo-sentilo-aca/ejemplo-sentilo-aca.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="ejemplo-sentilo-aca">
<h1>Ejemplo Sentilo ACA<a class="headerlink" href="#ejemplo-sentilo-aca" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Fecha</th>
<th class="head">Autores</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>8 Noviembre 2017</td>
<td><ul class="first last simple">
<li>Wladimir Szczerban</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>©2017 Wladimir Szczerban</p>
</div></blockquote>
<p class="last">Excepto donde quede reflejado de otra manera, la presente documentación se halla bajo licencia: Creative Commons (Creative Commons - Attribution - Share Alike: <a class="reference external" href="http://creativecommons.org/licenses/by-sa/3.0/deed.es">http://creativecommons.org/licenses/by-sa/3.0/deed.es</a>)</p>
</div>
<div class="section" id="acceso-al-servicios-de-sensores-sentilo-de-la-aca">
<h2>Acceso al servicios de sensores Sentilo de la ACA<a class="headerlink" href="#acceso-al-servicios-de-sensores-sentilo-de-la-aca" title="Permalink to this headline">¶</a></h2>
<p>En el apartado de consulta de datos de la página de la ACA <a class="footnote-reference" href="#id13" id="id1">[1]</a> encontramos un subapartado de datos en tiempo real, estos datos los sirven utilizando la plataforma Sentilo <a class="footnote-reference" href="#id14" id="id2">[2]</a>. Estos sensores dan información sobre los diferentes embalses/pantanos que hay en Cataluña.</p>
<p>La página tiene un acceso a un mapa con los datos de los diferentes sensores <a class="footnote-reference" href="#id15" id="id3">[3]</a> este mapa és el que ofrece la plataforma de Sentilo y está basado en tecnología de Google Maps.</p>
<p>También encontramos la documentación <a class="footnote-reference" href="#id16" id="id4">[4]</a> para usar la API, lo que nos permite acceder a los datos y generar nuestro propio visor.</p>
</div>
<div class="section" id="creacion-de-un-visor">
<h2>Creación de un visor<a class="headerlink" href="#creacion-de-un-visor" title="Permalink to this headline">¶</a></h2>
<p>Para crear un visor de mapas utilizaremos la librería de mapas Leaflet <a class="footnote-reference" href="#id17" id="id5">[5]</a>.</p>
<ol class="arabic">
<li><p class="first">Crear una carpeta con el nombre de <em>visor-aca</em>.</p>
</li>
<li><p class="first">Crear un archivo con el nombre de <em>index.html</em> dentro de la carpeta.</p>
</li>
<li><p class="first">Abrir el archivo index.html con un editor de texto y copiar el siguiente código.</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
        &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
        &lt;title&gt;Ejemplo Sentilo ACA&lt;/title&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.2.0/dist/leaflet.css&quot; /&gt;
        &lt;style&gt;
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;

        &lt;div id=&quot;map&quot;&gt;

    &lt;/div&gt;

        &lt;script src=&quot;https://unpkg.com/leaflet@1.2.0/dist/leaflet.js&quot;&gt;&lt;/script&gt;
        &lt;script&gt;
                var map = L.map(&#39;map&#39;);

        map.setView([41.5087, 2.1777], 8);

        L.tileLayer(&#39;http://{s}.tile.osm.org/{z}/{x}/{y}.png&#39;, {
            attribution: &#39;&amp;copy; &lt;a href=&quot;http://osm.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors&#39;
        }).addTo(map);
        &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
</li>
<li><p class="first">Abrir el archivo index.html en el navegador para confirmar que se carga un mapa centrado en Cataluña.</p>
</li>
<li><p class="first">Miramos la documentación de la API y buscar la url de descripción del servicio que es <a class="reference external" href="http://aca-web.gencat.cat/sdim2/apirest/catalog">http://aca-web.gencat.cat/sdim2/apirest/catalog</a>. Abrir esta url en el navegador y ver que responde un JSON con la información de los diferentes sensores.</p>
</li>
<li><p class="first">Revisar el JSON de salida y buscar la propiedad <em>location</em> que nos indica las coordenadas de la ubicación del sensor. A pesar de que el JSON tiene coordenadas no es un GeoJSON y por lo tanto no lo podemos pintar automaticamente en nuestro mapa.</p>
</li>
<li><p class="first">Cargar este JSON en nuestro mapa utilizando un plugin de Leaflet llamado <em>leaflet-ajax</em> <a class="footnote-reference" href="#id18" id="id6">[6]</a>. Este plugin permite hacer una llama AJAX a un servicio que retorne un JSON y cargar la respuesta en un mapa. Para cargar este plugin debemos agregar lo siguiente justo después de donde cargarmos el leaflet</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;script src=&quot;https://calvinmetcalf.github.io/leaflet-ajax/dist/leaflet.ajax.js&quot;&gt;&lt;/script&gt;
</pre></div>
</div>
</li>
<li><p class="first">Agregar la capa al mapa llamaremos a la API de la ACA utilizando el plugin. Para ello al final de nuestro código agregar lo siguiente:</p>
<div class="highlight-python"><div class="highlight"><pre>var geojsonLayer = new L.GeoJSON.AJAX(&#39;http://aca-web.gencat.cat/sdim2/apirest/catalog&#39;).addTo(map);
</pre></div>
</div>
</li>
<li><p class="first">Recargar la página y ver que no aparece ninguna información en el mapa. Abrir la consola de desarrollador del navegador (Ctrl+F12) para ver que aparece un mensaje de error <em>XMLHttpRequest cannot load ...</em> esto es debido a que estamos llamado a un servicio que no está en nuestro dominio y da un error de CORS <a class="footnote-reference" href="#id19" id="id7">[7]</a>. Para evitar el error de CORS necesitamos un proxy <a class="footnote-reference" href="#id20" id="id8">[8]</a> en nuestro servidor web que pueda hacer la llamada al servicio de la ACA y que nos devuelva el contenido.</p>
</li>
</ol>
</div>
<div class="section" id="creacion-del-proxy">
<h2>Creación del proxy<a class="headerlink" href="#creacion-del-proxy" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Instalar Node.js <a class="footnote-reference" href="#id21" id="id9">[9]</a>. Descargar la última versión LTS (en este momento es la 8.9.1 LTS) y lo instalaremos con las opciones por defecto. Una vez instalado el Node abrir la consola para verificar que se ha instalado correctamente. Escribir</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">node</span> <span class="o">-</span><span class="n">v</span>
</pre></div>
</div>
</li>
<li><p class="first">Navegar hasta nuestra carpeta <em>visor-aca</em> y escribir:</p>
<div class="highlight-python"><div class="highlight"><pre>npm init

Con este comando estaremos creando el archivo *package.json*. Este comando solicita varios elementos como, por ejemplo, el nombre y la versión de la aplicación. Por ahora, sólo hay que pulsar ENTER para aceptar los valores predeterminados.
</pre></div>
</div>
</li>
<li><p class="first">Instalar las dependencias para crear nuestro servicio de proxy. En este caso utilizaremos Express <a class="footnote-reference" href="#id22" id="id10">[10]</a> como servidor web y el módulo http-proxy <a class="footnote-reference" href="#id23" id="id11">[11]</a> .</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Instalar el express y guardarlo en la lista de dependencias</p>
<div class="highlight-python"><div class="highlight"><pre>npm install express --save
</pre></div>
</div>
</li>
<li><p class="first">Instalar el http-proxy y guardarlo en la lista de dependencias</p>
<div class="highlight-python"><div class="highlight"><pre>npm install http-proxy --save
</pre></div>
</div>
</li>
</ol>
<p>Al ejecutar estos comandos veremos que se crea una carpeta llamada <em>node_modules</em> donde se guardan los módulos instalados.</p>
</div></blockquote>
</li>
<li><p class="first">Crear un archivo llamado <em>app.js</em> que servirá de proxy con el servicio de la ACA. Copiar lo siguiente en este archivo.</p>
<div class="highlight-python"><div class="highlight"><pre>var express  = require(&#39;express&#39;);
var app      = express();
var httpProxy = require(&#39;http-proxy&#39;);
var apiProxy = httpProxy.createProxyServer();
var serverAca = &#39;http://aca-web.gencat.cat/sdim2/apirest/catalog&#39;;

app.get(&#39;/&#39;, function(req, res){
        res.sendFile(__dirname + &#39;/index.html&#39;);
});

app.all(&quot;/aca/*&quot;, function(req, res) {
    console.log(&#39;redirecting to Server1&#39;);
    apiProxy.web(req, res, {
        target: serverAca,
        changeOrigin: false,
        ignorePath: true
    });
});

app.listen(3000);
</pre></div>
</div>
</li>
<li><p class="first">Probar que nuestro proxy está funcionando, escribiendo:</p>
<div class="highlight-python"><div class="highlight"><pre>node app.js
</pre></div>
</div>
</li>
<li><p class="first">Abrir la url de nuestro proxy <a class="reference external" href="http://localhost:3000/aca/">http://localhost:3000/aca/</a> en el navegador.</p>
</li>
<li><p class="first">Escribir en el navegador <a class="reference external" href="http://localhost:3000">http://localhost:3000</a> y ver nuestro mapa.</p>
</li>
<li><p class="first">Modificar el archivo index.html para que llame al proxy que hemos creado. Cambiar la url de la capa geojsonLayer <em>http://aca-web.gencat.cat/sdim2/apirest/catalog</em> por nuestro proxy <em>http://localhost:3000/aca/</em> (como el proxy y la aplicación están en el mismo servidor podríamos usar <em>/aca/</em>).</p>
</li>
<li><p class="first">Recargar la aplicación con Ctrl+F5 y vemos que el error ha desaparecido. Continuamos sin ver ningún dato en nuestro mapa. Esto es debido a lo que ya mencionamos que lo que retorna la API no es un GeoJSON. Por lo tanto tenemos que convertir la respuesta de la API en un GeoJSON,</p>
</li>
<li><p class="first">Convertir la respuesta en un GeoJSON utilizando la opción <em>middleware</em> que ofrece la capa GeoJSON.AJAX. Esta opción permite crear una funcion donde se pueden manipular los datos antes de agregarlos al mapa. Crear la función que transforma los datos de Sentilo de la ACA en un GeoJSON. Al final de nuestro código escribir</p>
<div class="highlight-python"><div class="highlight"><pre>        function sentiloAca2geoJSON(data){
        var geojson = {
                type: &quot;FeatureCollection&quot;,
                features: []
        };
        var sensors = data.providers[0].sensors;
        for (var i = sensors.length - 1; i &gt;= 0; i--) {
                var sensor = sensors[i];
                var location = sensor.location.split(&quot; &quot;);
                var feature = {
                        type: &#39;Feature&#39;,
                        properties: {
                            description: sensor.description,
                            id: sensor.component,
                            nom: sensor.componentDesc,
                            info: sensor.componentAdditionalInfo,
                            unit: sensor.unit
                        },
                        geometry: {
                            type: &#39;Point&#39;,
                            coordinates: [location[1], location[0]]
                        }
                    };
                    geojson.features.push(feature);
        }
        return geojson;
}
</pre></div>
</div>
</li>
<li><p class="first">Modficar la capa geojsonLayer para que el middleware llame a nuestra función de transformación. Cambiar el código de la capa por lo siguiente:</p>
<div class="highlight-python"><div class="highlight"><pre>    var geojsonLayer = new L.GeoJSON.AJAX(&#39;http://localhost:3000/aca/&#39;, {
    middleware:function(data){
            return sentiloAca2geoJSON(data);
    }
}).addTo(map);
</pre></div>
</div>
</li>
<li><p class="first">Recargar el mapa y ver los puntos de los embalses en el mapa.</p>
</li>
<li><p class="first">Mostrar la información del punto. Agregar el evento click en cada unos de los puntos. Para ello utilizar la opción de <em>onEachFeature</em> que ofrece las capa GeoJSON de Leaflet. Esta opción permite ejecutar una función en la creación de cada uno de los elementos de la capa. Es muy útil para agregar popups a los elementos o para agregar eventos en los elementos.</p>
</li>
<li><p class="first">Crear una función llamada <em>eachFeature</em> que recibe como parámetros un feature (elemento del GeoJSON) y un layer (elemento de Leaflet). La función sería la siguiente</p>
<div class="highlight-python"><div class="highlight"><pre>function eachFeature(f,l){
l.on(&#39;click&#39;,function(ev){
        console.log(f);
        console.log(l);
        });
}
</pre></div>
</div>
</li>
<li><p class="first">Recargar el mapa y hacer click sobre un elemento. En la consola de desarrollador ver que aparecen 2 entradas una que corresponde al feature y otra al layer.</p>
</li>
<li><p class="first">Llamar a la API de la ACA para pedir la última lectura del sensor y así obtener la información. La url para obtener la última lectura es <a class="reference external" href="http://aca-web.gencat.cat/sentilo-catalog-web/component/map/EMBASSAMENT-EST.*">http://aca-web.gencat.cat/sentilo-catalog-web/component/map/EMBASSAMENT-EST.*</a>.&lt;id_sensor&gt;*/lastOb/. Por ejemplo</p>
<div class="highlight-python"><div class="highlight"><pre>http://aca-web.gencat.cat/sentilo-catalog-web/component/map/EMBASSAMENT-EST.L25075-72-00003/lastOb/

Como estamos llamando una url que está fuera de nuestro dominio tenemos el mismo problema de CORS.
</pre></div>
</div>
</li>
<li><p class="first">Modificar nuestro proxy para obtener la información de un sensor. En nuestro archivo app.js escribir justo debajo de la declaración de la variable <em>serverAca</em></p>
<div class="highlight-python"><div class="highlight"><pre>var serverAcaLastOb = &#39;http://aca-web.gencat.cat/sentilo-catalog-web/component/map/EMBASSAMENT-EST.&#39;;
</pre></div>
</div>
</li>
<li><p class="first">Agregar justo antes del app.listen el código que nos va a ser de proxy. Copiar lo siguiente</p>
<div class="highlight-python"><div class="highlight"><pre>app.all(&quot;/acalast/:id&quot;, function(req, res){
        console.log(&#39;redirecting to Server2&#39; + req.params.id);
        apiProxy.web(req, res, {
        target: serverAcaLastOb+req.params.id+&#39;/lastOb/&#39;,
        changeOrigin: false,
        ignorePath: true
    });
});
</pre></div>
</div>
</li>
<li><p class="first">Reiniciar nuestro servidor de node, ir a la consola y presionar Crtl+c. Luego escribir node app.js.</p>
</li>
<li><p class="first">Abrir la url <a class="reference external" href="http://localhost:3000/acalast/L25075-72-00003">http://localhost:3000/acalast/L25075-72-00003</a> en el navegador para comprovar que el proxy está funcionando correctamente.</p>
</li>
<li><p class="first">Modificar la función que se llama al hacer click sobre un elemento del mapa para que llame a nuestro proxy. Esta función ejecutará una llamada ajax al proxy. Utilizaremos la librería JQuery <a class="footnote-reference" href="#id24" id="id12">[12]</a> para hacer la llamada ajax. Escribir los siguiente justo debajo de donde cargarmos la librería de leaflet.ajax</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;script src=&quot;https://code.jquery.com/jquery-3.2.1.min.js&quot; integrity=&quot;sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
</pre></div>
</div>
</li>
<li><p class="first">Modificar la función <em>eachFeature</em> con el siguiente código</p>
<div class="highlight-python"><div class="highlight"><pre>function eachFeature(f,l){
l.on(&#39;click&#39;,function(ev){
        var url = &#39;http://localhost:3000/acalast/&#39;+f.properties.id;
        $.ajax({
                  url: url,
                }).done(function(result) {
                  console.log(result);
                });
        });
}
</pre></div>
</div>
</li>
<li><p class="first">Recargar el mapa y hacer click sobre un elemento para ver que en la consola del desarrollador aparece un objeto que contiene la respuesa del sensor con la información de la última lectura.</p>
</li>
<li><p class="first">Creamos una función llamada <em>popUp</em> para mostrar esta información en el mapa. La función recibe como parámetros un layer de Leaflet y unos datos del sensor. Esta función muestra un popup asociado al elemento con la información del sensor. Despues de la función eachFeature escrbir</p>
<div class="highlight-python"><div class="highlight"><pre>function popUp(l, data){
        var out = [];
        out.push(&#39;&lt;strong&gt;&#39;+data.componentDesc+&#39;&lt;/strong&gt;&#39;);
    if (data.sensorLastObservations){
        for (var i = data.sensorLastObservations.length - 1; i &gt;= 0; i--) {
                var observ = data.sensorLastObservations[i];
                out.push(observ.sensorType+&quot;: &quot;+observ.value+&quot; &quot;+observ.unit);
        }
    }
    l.unbindPopup();
    l.bindPopup(out.join(&quot;&lt;br /&gt;&quot;)).togglePopup();
}
</pre></div>
</div>
</li>
<li><p class="first">Llamar a la función popUp dentro de la función que se llama en el <em>done</em> de la llamada ajax. Para ello escribir</p>
<div class="highlight-python"><div class="highlight"><pre>.done(function(result) {
  console.log(result);
  popUp(l, result);
});
</pre></div>
</div>
</li>
<li><p class="first">Recargar la aplicación y hacer click sobre un elemento, debe aparecer un popup con la información de la última lectura del sensor.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><img alt="captura ejemplo sentilo ACA" class="align-middle" src="../_images/sentilo_aca.png" /></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ol>
<div class="section" id="referencias">
<h3>Referencias<a class="headerlink" href="#referencias" title="Permalink to this headline">¶</a></h3>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://aca-web.gencat.cat/aca/appmanager/aca/aca?_nfpb=true&amp;_pageLabel=P56600137761453129970599">http://aca-web.gencat.cat/aca/appmanager/aca/aca?_nfpb=true&amp;_pageLabel=P56600137761453129970599</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://www.sentilo.io/wordpress/">http://www.sentilo.io/wordpress/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://aca-web.gencat.cat/sentilo-catalog-web/component/map">http://aca-web.gencat.cat/sentilo-catalog-web/component/map</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="http://aca-web.gencat.cat/aca/documents/Consulta_dades/dades_obertes_tempsreal/us_serveis_dades_API_REST.pdf">http://aca-web.gencat.cat/aca/documents/Consulta_dades/dades_obertes_tempsreal/us_serveis_dades_API_REST.pdf</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="http://leafletjs.com/">http://leafletjs.com/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id18" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td><a class="reference external" href="https://github.com/calvinmetcalf/leaflet-ajax">https://github.com/calvinmetcalf/leaflet-ajax</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td><a class="reference external" href="https://developer.mozilla.org/es/docs/Web/HTTP/Access_control_CORS">https://developer.mozilla.org/es/docs/Web/HTTP/Access_control_CORS</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id20" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td><a class="reference external" href="https://es.wikipedia.org/wiki/Servidor_proxy">https://es.wikipedia.org/wiki/Servidor_proxy</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id21" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[9]</a></td><td><a class="reference external" href="https://nodejs.org/es/">https://nodejs.org/es/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id22" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[10]</a></td><td><a class="reference external" href="http://expressjs.com/">http://expressjs.com/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id23" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[11]</a></td><td><a class="reference external" href="https://github.com/nodejitsu/node-http-proxy">https://github.com/nodejitsu/node-http-proxy</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id24" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id12">[12]</a></td><td><a class="reference external" href="https://jquery.com/">https://jquery.com/</a></td></tr>
</tbody>
</table>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2013, Varios.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>